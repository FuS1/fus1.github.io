<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月度排班表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .schedule-cell { min-width: 120px; height: 70px; position: relative; }
        .schedule-cell:hover { background-color: #374151; }
        .employee-tag { display: block; text-align: center; padding: 4px; border-radius: 4px; font-weight: 500; }
        .time-override { font-size: 0.7rem; color: #d1d5db; margin-top: 2px; }
        .note-marker {
            position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid; border-width: 0 12px 12px 0;
            border-color: transparent #ef4444 transparent transparent; /* red-500 */
        }
        .tooltip {
            visibility: hidden; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 10;
            bottom: 105%; left: 50%; margin-left: -100px; width: 200px;
            opacity: 0; transition: opacity 0.3s; white-space: pre-wrap;
            border: 2px solid #cacaca;
        }
        .schedule-cell:hover .tooltip { visibility: visible; opacity: 0.9; }
        .date-cell { cursor: pointer; } /* Make the whole date cell clickable */
        .date-cell-header { display: flex; justify-content: space-between; align-items: center; }
        .date-highlighter-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
            <div><h1 class="text-4xl font-bold text-white">月度排班表</h1></div>
            <div class="flex gap-2">
                 <button id="auto-schedule-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">自動排班</button>
                 <a href="setup.html" class="text-blue-400 hover:text-blue-500 font-bold py-2 px-4 rounded-lg transition">&larr; 回到系統設定</a>
            </div>
        </header>
        
        <div class="flex items-center justify-between gap-4 mb-4 bg-gray-800 p-3 rounded-xl">
             <div id="store-tabs" class="flex flex-nowrap space-x-2 overflow-x-auto"></div>
             <div id="date-navigator" class="flex items-center justify-center gap-2 flex-shrink-0">
                <button id="prev-btn" class="p-2 rounded-full hover:bg-gray-700">&lt;</button>
                <div id="date-display" class="text-lg md:text-xl font-semibold text-center w-32"></div>
                <button id="next-btn" class="p-2 rounded-full hover:bg-gray-700">&gt;</button>
            </div>
        </div>

        <main class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
            <table class="w-full text-center" id="schedule-table"></table>
        </main>
    </div>

    <!-- Quick Assign (Fuzzy Search) Dropdown -->
    <div id="quick-assign-dropdown" class="absolute z-50 bg-gray-700 rounded-lg shadow-2xl p-2 hidden">
        <input type="text" id="search-input" class="w-full bg-gray-600 p-2 rounded-md mb-2" placeholder="搜尋員工...">
        <div id="search-results" class="max-h-60 overflow-y-auto"></div>
    </div>
    
    <!-- Shift Detail Modal -->
    <div id="shift-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-11/12 md:w-[550px]">
            <h2 class="text-2xl font-semibold mb-6" id="detail-modal-title">班次詳情</h2>
            <form id="shift-detail-form">
                <input type="hidden" id="detail-date"><input type="hidden" id="detail-shift-id">
                <div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-1">排班員工</label><div class="relative"><input type="text" id="detail-employee-search" class="w-full bg-gray-700 p-2 rounded"><input type="hidden" id="detail-employee-id"><div id="detail-employee-results" class="absolute z-20 w-full bg-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto hidden mt-1"></div></div></div>
                <fieldset class="border border-gray-600 p-3 rounded-md mb-4"><legend class="px-2 text-gray-400">計畫時間</legend><div class="grid grid-cols-2 gap-4"><input type="time" id="detail-plan-start" class="w-full bg-gray-700 p-2 rounded"><input type="time" id="detail-plan-end" class="w-full bg-gray-700 p-2 rounded"></div></fieldset>
                <fieldset class="border border-gray-600 p-3 rounded-md mb-4"><legend class="px-2 text-gray-400">實際出勤</legend>
                    <div class="grid grid-cols-2 gap-4 mb-2 items-end">
                        <input type="time" id="detail-actual-start" class="w-full bg-gray-700 p-2 rounded">
                        <button type="button" id="clock-in-now" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">立即簽到</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 items-end">
                        <input type="time" id="detail-actual-end" class="w-full bg-gray-700 p-2 rounded">
                         <button type="button" id="clock-out-now" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">立即簽退</button>
                    </div>
                </fieldset>
                <div class="mb-4 bg-gray-900 p-3 rounded-lg"><div class="flex justify-between text-sm"><span>實際工時:</span><span id="att-actual-hours" class="font-mono">--</span></div><div class="flex justify-between text-sm mt-1"><span>遲到/早退(分):</span><span id="att-lateness" class="font-mono">--</span></div></div>
                <div class="mb-6"><label for="detail-notes" class="block text-sm font-medium text-gray-300 mb-1">備註</label><textarea id="detail-notes" rows="2" class="w-full bg-gray-700 p-2 rounded"></textarea></div>
                <div class="flex justify-end space-x-4"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">關閉</button><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">儲存</button></div>
            </form>
        </div>
    </div>
    
    <!-- Daily Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-11/12 md:w-3/4 lg:w-1/2">
             <h2 class="text-2xl font-semibold mb-1" id="summary-title">每日出勤總覽</h2><p class="text-sm text-gray-400 mb-6" id="summary-subtitle"></p>
             <div class="max-h-[60vh] overflow-y-auto"><table class="w-full text-left text-sm"><thead class="sticky top-0 bg-gray-800"><tr class="border-b border-gray-600"><th class="p-2">員工</th><th class="p-2">計畫</th><th class="p-2">實際</th><th class="p-2">工時</th><th class="p-2">遲到/早退(分)</th><th class="p-2">狀態</th></tr></thead><tbody id="summary-body"></tbody></table></div>
             <div class="text-right mt-6"><button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">關閉</button></div>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$(function() {
    let allEmployees = [], storesConfig = {}, schedules = {}, dateStyles = {}, currentStore = '', currentDate = new Date();
    const SPECIAL_IDS = { NO_SHIFT: '_NO_SHIFT_', MISSING: '_MISSING_' };
    const DATE_STYLES_MAP = { default: '', holiday: 'bg-gray-700/60', double_pay: 'bg-red-900/50' };

    function init() {
        loadData();
        renderStoreTabs();
        renderGrid();
        bindEvents();
    }

    function loadData() {
        storesConfig = JSON.parse(localStorage.getItem('stores_config')) || {};
        schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        dateStyles = JSON.parse(localStorage.getItem('date_styles')) || {};
        allEmployees = [];
        for (const storeName in storesConfig) { (storesConfig[storeName].employees || []).forEach(emp => { allEmployees.push({ ...emp, store: storeName }); }); }
        if (Object.keys(storesConfig).length > 0) currentStore = Object.keys(storesConfig)[0];
    }

    function saveData() {
        localStorage.setItem('schedules', JSON.stringify(schedules));
        localStorage.setItem('date_styles', JSON.stringify(dateStyles));
    }

    function renderGrid() {
        updateDateDisplay();
        const $table = $('#schedule-table').empty();
        const storeConfig = storesConfig[currentStore];
        if (!storeConfig) { $table.html('<tr><td class="p-8">請先設定門市。</td></tr>'); return; }
        const allShifts = storeConfig.shifts || [];
        if (allShifts.length === 0) { $table.html('<tr><td class="p-8">此門市尚未設定班別。</td></tr>'); return; }

        let thead = '<thead><tr class="bg-gray-700"><th class="p-2 border-r border-gray-600 sticky left-0 bg-gray-700 z-10 w-40">日期</th>';
        allShifts.forEach(shift => { thead += `<th class="p-2 border-r border-gray-600">${shift.name}<br><span class="text-xs text-gray-400">${shift.time}</span></th>`; });
        thead += '</tr></thead>';
        $table.append(thead);

        let tbody = '<tbody>';
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day), dateStr = date.toISOString().split('T')[0];
            const dayOfWeek = date.getDay(), dayOfWeekStr = ['日', '一', '二', '三', '四', '五', '六'][dayOfWeek];
            const isWeekendByDefault = (dayOfWeek === 0 || dayOfWeek === 6);
            let dayStyle = dateStyles[dateStr] || (isWeekendByDefault ? 'holiday' : 'default');

            tbody += `<tr class="${DATE_STYLES_MAP[dayStyle]}"><td class="date-cell p-2 border-r border-t border-gray-600 sticky left-0 z-10 ${DATE_STYLES_MAP[dayStyle] || 'bg-gray-800'}" data-date="${dateStr}" data-style="${dayStyle}">
                <div class="date-cell-header">${month + 1}/${day} (${dayOfWeekStr})
                    <div>
                        <span class="date-highlighter-dot" style="background-color:${dayStyle === 'double_pay' ? '#991b1b' : (dayStyle === 'holiday' ? '#4b5563' : 'transparent')};"></span>
                        <button class="summary-btn text-xs ml-2 hover:bg-gray-600 px-1 rounded" data-date="${dateStr}">總覽</button>
                    </div>
                </div>
            </td>`;

            allShifts.forEach(shift => {
                const scheduleData = schedules[dateStr]?.[currentStore]?.[shift.id];
                let content = '';
                if (scheduleData && scheduleData.employeeId) {
                    const { employeeId, plan_start, plan_end, notes } = scheduleData;
                    if (employeeId === SPECIAL_IDS.NO_SHIFT) { content = `<span class="employee-tag" style="background-color:#111827; color:white;">不排班</span>`; }
                    else if (employeeId === SPECIAL_IDS.MISSING) { content = `<span class="employee-tag" style="background-color:#7f1d1d; color:white;">缺</span>`; }
                    else {
                        const emp = allEmployees.find(e => e.id === employeeId);
                        if (emp) {
                             const color = emp.color || '#374151', textColor = isDark(color) ? 'white' : 'black';
                             const isSupport = emp.store !== currentStore;
                             const displayName = isSupport ? `<i class="font-normal">支-${emp.name}</i>` : emp.name;
                             let timeOverrideHtml = '';
                             const defaultTime = shift.time.split('-');
                             if ((plan_start && plan_start !== defaultTime[0]) || (plan_end && plan_end !== defaultTime[1])) { timeOverrideHtml = `<div class="time-override">${plan_start || defaultTime[0]}-${plan_end || defaultTime[1]}</div>`; }
                             let noteMarkerHtml = '';
                             if (notes) { noteMarkerHtml = `<div class="note-marker"></div><div class="tooltip">${notes}</div>`; }
                             content = `<div><span class="employee-tag" style="background-color:${color}; color:${textColor};">${displayName}</span>${timeOverrideHtml}</div>${noteMarkerHtml}`;
                        }
                    }
                }
                tbody += `<td class="schedule-cell border-r border-t border-gray-600 p-1" data-date="${dateStr}" data-shift-id="${shift.id}">${content}</td>`;
            });
            tbody += '</tr>';
        }
        tbody += '</tbody>';
        $table.append(tbody);
    }
    
    function renderQuickAssignResults(term, $resultsContainer) {
        $resultsContainer.empty();
        const activeEmployees = allEmployees.filter(e => !e.resigned);
        const localStaff = activeEmployees.filter(e => e.store === currentStore && e.name.toLowerCase().includes(term.toLowerCase()));
        const supportStaff = activeEmployees.filter(e => e.store !== currentStore && e.name.toLowerCase().includes(term.toLowerCase()));

        $resultsContainer.append(`<div class="p-2 text-red-400 hover:bg-gray-600 cursor-pointer" data-id="">-- 清除 --</div>`);
        $resultsContainer.append(`<div class="p-2 hover:bg-gray-600 cursor-pointer" data-id="${SPECIAL_IDS.NO_SHIFT}">不排班</div>`);
        $resultsContainer.append(`<div class="p-2 hover:bg-gray-600 cursor-pointer" data-id="${SPECIAL_IDS.MISSING}">缺</div><hr class="border-gray-500 my-1">`);
        
        localStaff.forEach(emp => { $resultsContainer.append(`<div class="p-2 hover:bg-gray-500 cursor-pointer" data-id="${emp.id}">${emp.name}</div>`); });
        if (supportStaff.length > 0) {
             if (localStaff.length > 0) $resultsContainer.append('<hr class="border-gray-500 my-1">');
             supportStaff.forEach(emp => { $resultsContainer.append(`<div class="p-2 hover:bg-gray-500 cursor-pointer" data-id="${emp.id}">支-${emp.name} (${emp.store})</div>`); });
        }
    }
    
    function autoSchedule() { /* ... unchanged ... */ }
    function openDetailModal(date, shiftId) { /* ... unchanged ... */ }
    function showDailySummary(date) { /* ... unchanged ... */ }
    function calculateSingleAttendance(shift, scheduleData) { /* ... unchanged ... */ }
    function timeStrToMins(timeStr) { /* ... unchanged ... */ }
    function calculateAttendanceInModal() { /* ... unchanged ... */ }

    function bindEvents() {
        $('#store-tabs').on('click', '.store-tab', function() { currentStore = $(this).data('store'); renderStoreTabs(); renderGrid(); });
        $('#prev-btn').on('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderGrid(); });
        $('#next-btn').on('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderGrid(); });
        $('#auto-schedule-btn').on('click', autoSchedule);

        // UPDATED: Distinguish clicks on date cell vs summary button
        $('#schedule-table').on('click', '.date-cell', function(e) {
            if ($(e.target).hasClass('summary-btn')) {
                e.stopPropagation();
                showDailySummary($(this).data('date'));
                return;
            }
            const date = $(this).data('date');
            const style = $(this).data('style');
            const styles = ['holiday', 'double_pay', 'default'];
            const next = (styles.indexOf(style) + 1) % styles.length;
            dateStyles[date] = styles[next];
            if (dateStyles[date] === 'default') delete dateStyles[date];
            saveData();
            renderGrid();
        });

        $('#schedule-table').on('click', '.schedule-cell', function() {
            const date = $(this).data('date'), shiftId = $(this).data('shift-id');
            const scheduleData = schedules[date]?.[currentStore]?.[shiftId];
            if (scheduleData && scheduleData.employeeId) {
                openDetailModal(date, shiftId);
            } else {
                const rect = this.getBoundingClientRect();
                $('#quick-assign-dropdown').data('cell', $(this)).css({ top: rect.bottom + window.scrollY, left: rect.left + window.scrollX }).show();
                $('#search-input').val('').focus();
                renderQuickAssignResults('', $('#search-results'));
            }
        });
        
        $('#search-input').on('keyup', function() { renderQuickAssignResults($(this).val(), $('#search-results')); });
        $('#quick-assign-dropdown').on('click', '#search-results div', function() {
            const $cell = $('#quick-assign-dropdown').data('cell');
            const date = $cell.data('date'), shiftId = $cell.data('shift-id'), employeeId = $(this).data('id');
            if (employeeId && !Object.values(SPECIAL_IDS).includes(employeeId)) {
                const daySchedule = schedules[date]?.[currentStore] || {};
                for (const otherShiftId in daySchedule) {
                    if (otherShiftId !== shiftId && daySchedule[otherShiftId].employeeId === employeeId) { alert(`錯誤：該員工在 ${date} 已被安排了其他班次。`); $('#quick-assign-dropdown').hide(); return; }
                }
            }
            if (!schedules[date]) schedules[date] = {};
            if (!schedules[date][currentStore]) schedules[date][currentStore] = {};
            schedules[date][currentStore][shiftId] = { employeeId: employeeId };
            saveData(); renderGrid(); $('#quick-assign-dropdown').hide();
        });

        $('#detail-employee-search').on('keyup', function() { renderQuickAssignResults($(this).val(), $('#detail-employee-results').show()); });
        $('#detail-employee-results').on('click', 'div', function() {
            const empId = $(this).data('id');
            const emp = allEmployees.find(e => e.id === empId);
            $('#detail-employee-search').val(emp ? emp.name : ($(this).text().startsWith('--') ? '' : $(this).text()));
            $('#detail-employee-id').val(empId);
            $('#detail-employee-results').hide();
        });

        $('.cancel-btn').on('click', () => { $('#shift-detail-modal, #summary-modal').addClass('hidden'); });
        $('#shift-detail-form').on('submit', function(e) {
            e.preventDefault();
            const date = $('#detail-date').val(), shiftId = $('#detail-shift-id').val();
            const employeeId = $('#detail-employee-id').val();
            if (employeeId && !Object.values(SPECIAL_IDS).includes(employeeId)) {
                const daySchedule = schedules[date]?.[currentStore] || {};
                for (const otherShiftId in daySchedule) {
                    if (otherShiftId !== shiftId && daySchedule[otherShiftId].employeeId === employeeId) { alert(`錯誤：該員工在 ${date} 已被安排了其他班次。`); return; }
                }
            }
            if (!schedules[date]) schedules[date] = {};
            if (!schedules[date][currentStore]) schedules[date][currentStore] = {};
            schedules[date][currentStore][shiftId] = { employeeId: employeeId, plan_start: $('#detail-plan-start').val(), plan_end: $('#detail-plan-end').val(), actual_start: $('#detail-actual-start').val(), actual_end: $('#detail-actual-end').val(), notes: $('#detail-notes').val() };
            saveData(); renderGrid(); $('#shift-detail-modal').addClass('hidden');
        });

        $('#shift-detail-modal input').on('input change', calculateAttendanceInModal);
        $('#clock-in-now').on('click', () => { $('#detail-actual-start').val(new Date().toTimeString().substring(0,5)).trigger('change'); });
        $('#clock-out-now').on('click', () => { $('#detail-actual-end').val(new Date().toTimeString().substring(0,5)).trigger('change'); });
        $(document).on('click', (e) => { if (!$(e.target).closest('.schedule-cell, .date-cell, #quick-assign-dropdown, #shift-detail-modal').length) $('#quick-assign-dropdown, #detail-employee-results').hide(); });
    }
    
    // --- Unchanged Functions ---
    function isDark(color) { if (!color || color.length < 7) return false; const c = color.substring(1), rgb = parseInt(c, 16); const r = (rgb >> 16) & 0xff, g = (rgb >> 8) & 0xff, b = (rgb >> 0) & 0xff; return (0.2126 * r + 0.7152 * g + 0.0722 * b) < 128; }
    function autoSchedule() { if (!confirm('此操作將會自動填滿本月所有「空白」的儲存格。任何已安排的儲存格 (包含不排班、缺) 將不會變動。\n\n確定要繼續嗎？')) return; const localStaffPool = (storesConfig[currentStore]?.employees || []).filter(e => !e.resigned); if (localStaffPool.length === 0) { alert('目前門市沒有可排班的在職員工！'); return; } const year = currentDate.getFullYear(), month = currentDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const shifts = storesConfig[currentStore]?.shifts || []; for (let day = 1; day <= daysInMonth; day++) { const dateStr = new Date(year, month, day).toISOString().split('T')[0]; if (!schedules[dateStr]) schedules[dateStr] = {}; if (!schedules[dateStr][currentStore]) schedules[dateStr][currentStore] = {}; const daySchedule = schedules[dateStr][currentStore]; const staffWorkingToday = new Set(Object.values(daySchedule).map(d => d.employeeId).filter(id => id && !Object.values(SPECIAL_IDS).includes(id))); let availableStaffForThisDay = [...localStaffPool].filter(emp => !staffWorkingToday.has(emp.id)); availableStaffForThisDay.sort(() => 0.5 - Math.random()); shifts.forEach(shift => { const currentAssignment = daySchedule[shift.id]; if (!currentAssignment) { if (availableStaffForThisDay.length > 0) { const assignedStaff = availableStaffForThisDay.pop(); daySchedule[shift.id] = { employeeId: assignedStaff.id }; } else { daySchedule[shift.id] = { employeeId: SPECIAL_IDS.MISSING }; } } }); } saveData(); renderGrid(); alert('自動排班完成！'); }
    function renderStoreTabs() { const $tabs = $('#store-tabs').empty(); Object.keys(storesConfig).forEach(name => { const active = name === currentStore ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'; $tabs.append(`<button class="store-tab flex-shrink-0 px-4 py-2 rounded-lg font-semibold ${active}" data-store="${name}">${name}</button>`); }); }
    function updateDateDisplay() { $('#date-display').text(`${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`); }
    function openDetailModal(date, shiftId) { const shift = (storesConfig[currentStore].shifts || []).find(s => s.id === shiftId); let scheduleData = schedules[date]?.[currentStore]?.[shiftId] || {}; const emp = allEmployees.find(e => e.id === scheduleData.employeeId); $('#detail-modal-title').text(`${date} - ${shift.name}`); $('#detail-date').val(date); $('#detail-shift-id').val(shiftId); $('#detail-employee-search').val(emp ? emp.name : ''); $('#detail-employee-id').val(scheduleData.employeeId); const defaultTime = shift.time.split('-'); $('#detail-plan-start').val(scheduleData.plan_start || defaultTime[0]); $('#detail-plan-end').val(scheduleData.plan_end || defaultTime[1]); $('#detail-actual-start').val(scheduleData.actual_start || ''); $('#detail-actual-end').val(scheduleData.actual_end || ''); $('#detail-notes').val(scheduleData.notes || ''); calculateAttendanceInModal(); $('#shift-detail-modal').removeClass('hidden'); }
    function showDailySummary(date) { $('#summary-title').text(`${date} 出勤總覽`); $('#summary-subtitle').text(currentStore); const $body = $('#summary-body').empty(); const daySchedule = schedules[date]?.[currentStore] || {}; const allShifts = storesConfig[currentStore]?.shifts || []; if (Object.values(daySchedule).length === 0) { $body.html('<tr><td colspan="6" class="p-4 text-center text-gray-400">本日無排班</td></tr>'); } else { allShifts.forEach(shift => { const scheduleData = daySchedule[shift.id]; if (!scheduleData || typeof scheduleData !== 'object' || !scheduleData.employeeId || Object.values(SPECIAL_IDS).includes(scheduleData.employeeId)) return; const emp = allEmployees.find(e => e.id === scheduleData.employeeId); if (!emp) return; const { hours, lateness, statusText } = calculateSingleAttendance(shift, scheduleData); $body.append(`<tr class="border-b border-gray-700"><td class="p-2">${emp.name}</td><td class="p-2 font-mono">${(scheduleData.plan_start || shift.time.split('-')[0])}-${(scheduleData.plan_end || shift.time.split('-')[1])}</td><td class="p-2 font-mono">${scheduleData.actual_start || '--'}-${scheduleData.actual_end || '--'}</td><td class="p-2">${hours}</td><td class="p-2">${lateness}</td><td class="p-2">${statusText}</td></tr>`); }); } $('#summary-modal').removeClass('hidden'); }
    function calculateSingleAttendance(shift, scheduleData) { const plan_start = scheduleData.plan_start || shift.time.split('-')[0]; const plan_end = scheduleData.plan_end || shift.time.split('-')[1]; const actualIn = scheduleData.actual_start, actualOut = scheduleData.actual_end; let hours = '--', lateness = '--', statusText = '未打卡'; if (scheduleData.status === 'leave') statusText = '請假'; else if (scheduleData.status === 'absent') statusText = '曠職'; else if (actualIn && actualOut) { const workMins = timeStrToMins(actualOut) - timeStrToMins(actualIn); hours = (workMins / 60).toFixed(2) + ' 小時'; const lateMins = timeStrToMins(actualIn) - timeStrToMins(plan_start); const earlyMins = timeStrToMins(plan_end) - timeStrToMins(actualOut); lateness = (lateMins > 0 ? lateMins : 0) + (earlyMins > 0 ? earlyMins : 0); statusText = '正常'; if (lateMins > 0) statusText = '遲到'; if (earlyMins > 0) statusText += (statusText === '正常' ? '早退' : '/早退'); } return { hours, lateness, statusText }; }
    function timeStrToMins(timeStr) { if (!timeStr) return 0; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }
    function calculateAttendanceInModal() { const shiftId = $('#detail-shift-id').val(); const shift = (storesConfig[currentStore]?.shifts || []).find(s => s.id === shiftId); if (!shift) return; const defaultTime = shift.time.split('-'); const planStart = $('#detail-plan-start').val() || defaultTime[0]; const planEnd = $('#detail-plan-end').val() || defaultTime[1]; const actualIn = $('#detail-actual-start').val(), actualOut = $('#detail-actual-end').val(); if (actualIn && actualOut) { const workMins = timeStrToMins(actualOut) - timeStrToMins(actualIn); $('#att-actual-hours').text(`${(workMins / 60).toFixed(2)} 小時`); const lateness = timeStrToMins(actualIn) - timeStrToMins(planStart); const earlyLeave = timeStrToMins(planEnd) - timeStrToMins(actualOut); $('#att-lateness').text(`${(lateness > 0 ? lateness : 0) + (earlyLeave > 0 ? earlyLeave : 0)} 分`); } else { $('#att-actual-hours').text('--'); $('#att-lateness').text('--'); } }
    
    init();
});
</script>
</body>
</html>