<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統設定</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
            <div>
                <h1 class="text-4xl font-bold text-white">系統設定</h1>
                <p class="text-gray-400 mt-1">在這裡管理員工、門市以及各門市的班別。設定完成後請務必儲存。</p>
            </div>
            <div class="flex gap-4">
                 <button id="reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">一鍵恢復預設值</button>
                 <a href="schedule.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">前往排班頁面 &rarr;</a>
            </div>
        </header>

        <!-- 員工管理 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">員工管理</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="text" id="employee-name" placeholder="員工姓名" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                <input type="color" id="employee-color" title="選擇顏色" class="bg-gray-700 border border-gray-600 rounded-lg h-10 w-full">
                <button id="add-employee-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">新增員工</button>
            </div>
            <div id="employee-list" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- 門市與班別設定 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">門市與班別設定</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Store Tabs -->
                <div id="store-tabs" class="flex md:flex-col flex-row flex-wrap md:flex-nowrap md:w-1/4 overflow-x-auto"></div>
                <!-- Shift Settings -->
                <div id="shift-settings" class="flex-grow"></div>
            </div>
            <div class="text-right mt-6">
                <button id="save-config-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">儲存所有設定</button>
            </div>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$(function() {
    let configData = {};
    let employees = [];
    let currentStore = '';
    const defaultStores = ['台北 旗艦店', '公館 體驗店', '新店 威秀店', '青埔 環球店', '中壢 中原店', '竹北 六家店', '台中 旗艦店', '台南 中山店', '高雄 旗艦店', '高雄 夢時代店'];

    function getDefaultData() {
        return {
            employees: [
                {id: 'emp_1', name: '奶茶', color: '#f8c9c9'}, {id: 'emp_2', name: 'Joanna', color: '#c9daf8'},
                {id: 'emp_3', name: '大寶', color: '#f4cccc'}, {id: 'emp_4', name: 'Fish', color: '#d9ead3'},
                {id: 'emp_5', name: '小蟬', color: '#fff2cc'}, {id: 'emp_6', name: 'Lumi', color: '#d0e0e3'},
                {id: 'emp_7', name: 'Lia', color: '#c9daf8'}, {id: 'emp_8', name: '亮亮', color: '#fce5cd'},
                {id: 'emp_9', name: '小王子', color: '#d9ead3'}, {id: 'emp_10', name: 'Yuki', color: '#f4cccc'},
                {id: 'emp_11', name: '小白羊', color: '#d0e0e3'}, {id: 'emp_12', name: 'YoYo', color: '#fff2cc'},
                {id: 'emp_13', name: '毛毛', color: '#d9ead3'}, {id: 'emp_14', name: 'Xyza', color: '#5b5b5b'},
                {id: 'emp_15', name: '小魚中壢店', color: '#f4cccc'}, {id: 'emp_16', name: '曲奇', color: '#fce5cd'},
                {id: 'emp_17', name: 'Litty', color: 'blue'}, {id: 'emp_18', name: '柯柯', color: '#f8c9c9'},
                {id: 'emp_19', name: '黛黛', color: '#d0e0e3'}, {id: 'emp_20', name: '小榛', color: '#fce5cd'},
            ],
            stores_config: {
                '台北 旗艦店': {
                    shifts: [
                        {id: 's_1', name: '早班 B', time: '08:30-16:00'}, {id: 's_2', name: '早班 C', time: '09:30-17:30'},
                        {id: 's_3', name: '午班', time: '12:00-20:00'}, {id: 's_4', name: '晚班 E', time: '13:00-21:00'},
                        {id: 's_5', name: '晚班(新人)', time: '15:00-22:30'}
                    ],
                    admin_shifts: [
                        {id: 'a_1', name: '行政人力', time: '10:00-18:00'}
                    ]
                }
            }
        };
    }

    function init() {
        loadData();
        renderEmployeeList();
        renderStoreTabs();
        bindEvents();
    }

    function loadData() {
        employees = JSON.parse(localStorage.getItem('employees')) || [];
        configData = JSON.parse(localStorage.getItem('stores_config')) || {};
        
        if (employees.length === 0 || Object.keys(configData).length === 0) {
            resetToDefaults();
        } else {
            currentStore = Object.keys(configData)[0];
        }
    }
    
    function resetToDefaults() {
        if (confirm('這將會清除所有自訂的員工和班別設定，並恢復為預設範本。確定要繼續嗎？')) {
            const defaults = getDefaultData();
            employees = defaults.employees;
            configData = defaults.stores_config;
            
            defaultStores.forEach(storeName => {
                if (!configData[storeName]) {
                    configData[storeName] = JSON.parse(JSON.stringify(defaults.stores_config['台北 旗艦店']));
                }
            });
            
            currentStore = Object.keys(configData)[0];
            saveAllData();
            renderEmployeeList();
            renderStoreTabs();
        }
    }
    
    function saveAllData() {
        localStorage.setItem('employees', JSON.stringify(employees));
        localStorage.setItem('stores_config', JSON.stringify(configData));
    }

    function renderEmployeeList() {
        const $list = $('#employee-list').empty();
        employees.forEach(emp => {
            $list.append(`<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium" style="background-color:${emp.color}; color:${isDark(emp.color) ? 'white' : 'black'};">
                ${emp.name}
                <button class="delete-employee" data-id="${emp.id}">&times;</button>
            </span>`);
        });
    }

    function renderStoreTabs() {
        const $tabs = $('#store-tabs').empty();
        Object.keys(configData).forEach(storeName => {
            const activeClass = storeName === currentStore ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600';
            $tabs.append(`<button class="store-tab w-full text-left p-3 rounded-lg mb-2 ${activeClass}" data-store="${storeName}">${storeName}</button>`);
        });
        renderShiftSettings();
    }
    
    function renderShiftSettings() {
        const $settings = $('#shift-settings').empty();
        const storeConfig = configData[currentStore];
        if (!storeConfig) {
            $settings.html('<p>請選擇一個門市來設定班別。</p>');
            return;
        }

        const renderSection = (title, shifts, type) => {
            let html = `<div class="mb-6"><h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4">${title}</h3>`;
            html += '<div id="list-' + type + '" class="space-y-2">';
            shifts.forEach((shift, index) => {
                html += `<div class="flex items-center gap-2 bg-gray-700 p-2 rounded-md">
                    <input type="text" value="${shift.name}" class="shift-name flex-grow bg-gray-600 p-1 rounded" data-type="${type}" data-index="${index}">
                    <input type="text" value="${shift.time}" class="shift-time w-32 bg-gray-600 p-1 rounded" data-type="${type}" data-index="${index}">
                    <button class="delete-shift text-red-400" data-type="${type}" data-index="${index}">刪除</button>
                </div>`;
            });
            html += `</div><button class="add-shift mt-4 text-blue-400" data-type="${type}">+ 新增${title}</button></div>`;
            return html;
        };

        $settings.append(renderSection('主要班別', storeConfig.shifts || [], 'shifts'));
        $settings.append(renderSection('行政班別', storeConfig.admin_shifts || [], 'admin_shifts'));
    }

    function bindEvents() {
        $('#reset-btn').on('click', resetToDefaults);
        $('#save-config-btn').on('click', () => {
             saveAllData();
             alert('所有設定已儲存！');
        });

        $('#add-employee-btn').on('click', () => {
            const name = $('#employee-name').val();
            const color = $('#employee-color').val();
            if (name) {
                employees.push({id: 'emp_' + Date.now(), name, color});
                $('#employee-name').val('');
                renderEmployeeList();
            }
        });
        
        $('#employee-list').on('click', '.delete-employee', function() {
            const empId = $(this).data('id');
            employees = employees.filter(e => e.id !== empId);
            renderEmployeeList();
        });

        $('#store-tabs').on('click', '.store-tab', function() {
            currentStore = $(this).data('store');
            renderStoreTabs();
        });
        
        $('#shift-settings').on('click', '.add-shift', function() {
            const type = $(this).data('type');
            if(!configData[currentStore][type]) configData[currentStore][type] = [];
            configData[currentStore][type].push({id: `new_${Date.now()}`, name: '新班別', time: '00:00-00:00'});
            renderShiftSettings();
        });
        
        $('#shift-settings').on('click', '.delete-shift', function() {
            const type = $(this).data('type');
            const index = $(this).data('index');
            configData[currentStore][type].splice(index, 1);
            renderShiftSettings();
        });
        
        $('#shift-settings').on('change', 'input', function() {
            const type = $(this).data('type');
            const index = $(this).data('index');
            const field = $(this).hasClass('shift-name') ? 'name' : 'time';
            configData[currentStore][type][index][field] = $(this).val();
        });
    }
    
    function isDark(color) {
        const c = color.substring(1);
        const rgb = parseInt(c, 16);
        const r = (rgb >> 16) & 0xff;
        const g = (rgb >> 8) & 0xff;
        const b = (rgb >> 0) & 0xff;
        const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return luma < 128;
    }

    init();
});
</script>
</body>
</html>