<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統設定</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS Library for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
            <div>
                <h1 class="text-4xl font-bold text-white">系統設定</h1>
                <p class="text-gray-400 mt-1">在這裡管理各門市的人員與班別。可拖曳排序，設定完成後請務必儲存。</p>
            </div>
            <div class="flex gap-4">
                 <button id="reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">一鍵恢復預設值</button>
                 <a href="schedule.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">前往排班頁面 &rarr;</a>
            </div>
        </header>

        <!-- 門市與班別設定 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Store Tabs -->
                <div id="store-tabs" class="flex md:flex-col flex-row flex-wrap md:flex-nowrap md:w-1/4 overflow-x-auto"></div>
                <!-- Settings Panel -->
                <div id="settings-panel" class="flex-grow"></div>
            </div>
            <div class="text-right mt-6">
                <button id="save-config-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">儲存所有設定</button>
            </div>
        </div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$(function() {
    let configData = {};
    let currentStore = '';
    const defaultStores = ['台北 旗艦店', '公館 體驗店', '新店 威秀店', '青埔 環球店', '中壢 中原店', '竹北 六家店', '台中 旗艦店', '台南 中山店', '高雄 旗艦店', '高雄 夢時代店'];

    function getDefaultData() {
        return {
            '台北 旗艦店': {
                shifts: [ {id: 's_1', name: '早班', time: '09:00-17:00'}, {id: 's_2', name: '午班', time: '12:00-20:00'}, {id: 's_3', name: '晚班', time: '14:00-22:00'} ],
                employees: [
                    {id: 'emp_1', name: '奶茶', color: '#f8c9c9', resigned: false}, {id: 'emp_2', name: 'Joanna', color: '#c9daf8', resigned: false}
                ]
            },
            '台中 旗艦店': {
                shifts: [ {id: 's_4', name: '早', time: '09:30-17:30'}, {id: 's_5', name: '晚', time: '13:30-21:30'} ],
                employees: [
                    {id: 'emp_3', name: '林經理', color: '#f4cccc', resigned: false}, {id: 'emp_4', name: '小白羊', color: '#d0e0e3', resigned: true}
                ]
            }
        };
    }

    function init() {
        loadData();
        renderStoreTabs();
        bindEvents();
    }

    function loadData() {
        configData = JSON.parse(localStorage.getItem('stores_config')) || {};
        if (Object.keys(configData).length === 0) {
            resetToDefaults(false);
        } else {
            currentStore = Object.keys(configData)[0];
        }
    }
    
    function resetToDefaults(confirmReset = true) {
        const doReset = () => {
            configData = getDefaultData();
            defaultStores.forEach(storeName => {
                if (!configData[storeName]) {
                    configData[storeName] = { shifts: [], employees: [] };
                }
            });
            currentStore = Object.keys(configData)[0];
            saveAllData();
            renderStoreTabs();
        };
        
        if (confirmReset) {
            if (confirm('這將清除所有自訂設定並恢復為預設範本。確定嗎？')) doReset();
        } else {
            doReset();
        }
    }
    
    function saveAllData() {
        localStorage.setItem('stores_config', JSON.stringify(configData));
    }

    function renderStoreTabs() {
        const $tabs = $('#store-tabs').empty();
        Object.keys(configData).forEach(storeName => {
            const activeClass = storeName === currentStore ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600';
            $tabs.append(`<button class="store-tab w-full text-left p-3 rounded-lg mb-2 ${activeClass}" data-store="${storeName}">${storeName}</button>`);
        });
        renderSettingsPanel();
    }
    
    function renderSettingsPanel() {
        const $panel = $('#settings-panel').empty();
        const storeConfig = configData[currentStore];
        if (!storeConfig) return;

        // Render Shifts
        const renderShiftSection = () => {
            let html = `<div class="mb-6"><h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4">主要班別 (可拖曳排序)</h3>`;
            html += `<div id="list-shifts" class="space-y-2">`;
            (storeConfig.shifts || []).forEach((shift, index) => {
                html += `<div class="flex items-center gap-2 bg-gray-700 p-2 rounded-md" data-id="${shift.id}">
                    <svg class="w-5 h-5 cursor-grab flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v1.586l3.293-3.293a1 1 0 111.414 1.414L12.414 7H14a1 1 0 010 2h-1.586l3.293 3.293a1 1 0 11-1.414 1.414L11 10.414V12a1 1 0 01-2 0v-1.586l-3.293 3.293a1 1 0 11-1.414-1.414L7.586 9H6a1 1 0 010-2h1.586L4.293 3.707a1 1 0 011.414-1.414L9 5.586V4a1 1 0 011-1z"></path></svg>
                    <input type="text" value="${shift.name}" class="shift-name flex-grow bg-gray-600 p-1 rounded" data-index="${index}">
                    <input type="text" value="${shift.time}" class="shift-time w-32 bg-gray-600 p-1 rounded" data-index="${index}">
                    <button class="delete-shift text-red-400" data-index="${index}">刪除</button>
                </div>`;
            });
            html += `</div><button class="add-shift mt-4 text-blue-400">+ 新增班別</button></div>`;
            $panel.append(html);
            initSortable('#list-shifts', 'shifts');
        };
        
        // Render Employees
        const renderEmployeeSection = () => {
             let html = `<div class="mb-6"><h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4">門市人員 (可拖曳排序)</h3>`;
             html += `<div id="employee-list-in-store" class="space-y-2">`;
             (storeConfig.employees || []).forEach((emp, index) => {
                const resignedClass = emp.resigned ? 'opacity-50' : '';
                html += `<div class="flex items-center gap-2 bg-gray-700 p-2 rounded-md ${resignedClass}" data-id="${emp.id}">
                    <svg class="w-5 h-5 cursor-grab flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v1.586l3.293-3.293a1 1 0 111.414 1.414L12.414 7H14a1 1 0 010 2h-1.586l3.293 3.293a1 1 0 11-1.414 1.414L11 10.414V12a1 1 0 01-2 0v-1.586l-3.293 3.293a1 1 0 11-1.414-1.414L7.586 9H6a1 1 0 010-2h1.586L4.293 3.707a1 1 0 011.414-1.414L9 5.586V4a1 1 0 011-1z"></path></svg>
                    <input type="text" value="${emp.name}" class="emp-name flex-grow bg-gray-600 p-1 rounded" data-index="${index}">
                    <input type="color" value="${emp.color}" class="emp-color w-16 h-8 bg-gray-600 p-0 border-0 rounded" data-index="${index}">
                    <label class="flex items-center text-xs cursor-pointer"><input type="checkbox" ${emp.resigned ? 'checked' : ''} class="emp-resigned mx-2" data-index="${index}">離職</label>
                    <button class="delete-employee text-red-400" data-index="${index}">刪除</button>
                </div>`;
             });
             html += `</div><div class="mt-4 border-t border-gray-700 pt-4 flex gap-2 items-end">
                <input type="text" id="new-emp-name" placeholder="新員工姓名" class="flex-grow bg-gray-600 p-2 rounded">
                <input type="color" id="new-emp-color" value="#c9daf8" class="w-16 h-10 p-0 border-0 rounded">
                <button id="add-employee-btn" class="bg-green-500 p-2 rounded text-white">新增</button>
             </div></div>`;
             $panel.append(html);
             initSortable('#employee-list-in-store', 'employees');
        };

        renderShiftSection();
        renderEmployeeSection();
    }

    function initSortable(selector, type) {
        const el = document.querySelector(selector);
        if (!el) return;
        new Sortable(el, {
            animation: 150, handle: '.cursor-grab',
            onEnd: function(evt) {
                const list = configData[currentStore][type];
                const [movedItem] = list.splice(evt.oldIndex, 1);
                list.splice(evt.newIndex, 0, movedItem);
                renderSettingsPanel();
            }
        });
    }

    function bindEvents() {
        $('#reset-btn').on('click', () => resetToDefaults(true));
        $('#save-config-btn').on('click', () => { saveAllData(); alert('所有設定已儲存！'); });
        $('#store-tabs').on('click', '.store-tab', function() { currentStore = $(this).data('store'); renderStoreTabs(); });

        const panel = $('#settings-panel');
        panel.on('click', '.add-shift', () => {
            if(!configData[currentStore].shifts) configData[currentStore].shifts = [];
            configData[currentStore].shifts.push({id: `s_${Date.now()}`, name: '新班別', time: '00:00-00:00'});
            renderSettingsPanel();
        });
        panel.on('click', '.delete-shift', function() {
            configData[currentStore].shifts.splice($(this).data('index'), 1);
            renderSettingsPanel();
        });
        panel.on('change', '.shift-name, .shift-time', function() {
            const field = $(this).hasClass('shift-name') ? 'name' : 'time';
            configData[currentStore].shifts[$(this).data('index')][field] = $(this).val();
        });
        panel.on('click', '#add-employee-btn', function() {
            const name = $('#new-emp-name').val();
            if (name) {
                if(!configData[currentStore].employees) configData[currentStore].employees = [];
                configData[currentStore].employees.push({
                    id: 'emp_' + Date.now(), name: name, color: $('#new-emp-color').val(), resigned: false
                });
                renderSettingsPanel();
            }
        });
        panel.on('click', '.delete-employee', function() {
            configData[currentStore].employees.splice($(this).data('index'), 1);
            renderSettingsPanel();
        });
        panel.on('change', '.emp-name, .emp-color, .emp-resigned', function() {
             const index = $(this).data('index');
             if ($(this).hasClass('emp-name')) configData[currentStore].employees[index].name = $(this).val();
             if ($(this).hasClass('emp-color')) configData[currentStore].employees[index].color = $(this).val();
             if ($(this).hasClass('emp-resigned')) {
                configData[currentStore].employees[index].resigned = this.checked;
                renderSettingsPanel();
             }
        });
    }

    function isDark(color) {
        if (!color || color.length < 7) return false;
        const c = color.substring(1), rgb = parseInt(c, 16);
        const r = (rgb >> 16) & 0xff, g = (rgb >> 8) & 0xff, b = (rgb >> 0) & 0xff;
        return (0.2126 * r + 0.7152 * g + 0.0722 * b) < 128;
    }

    init();
});
</script>
</body>
</html>